<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Carlisle Halloween Candy Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #header {
        background-color: #ff6600;
        color: #fff;
        text-align: center;
        font-family: Arial, sans-serif;
        font-size: 20px;
        font-weight: bold;
        padding: 10px;
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 10;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }
      #refresh-btn {
        background-color: #fff;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 14px;
        cursor: pointer;
        margin-left: 10px;
      }
      #map {
        height: 100%;
        width: 100%;
        position: absolute;
        top: 50px;
        left: 0;
      }
      .gm-style-iw p { margin: 0; }
    </style>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkVmW-fM7yR9iVgoEZU8Kyhw54LeioIi0"></script>

    <script>
      let map;

      function initMap() {
        // Center on Carlisle, MA
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 42.529, lng: -71.35 },
          zoom: 14,
          mapTypeId: "roadmap",
        });

        loadKML();
      }

      function loadKML() {
        // Your same Drive-hosted KML file
        const kmlUrl = "const kmlUrl = "https://raw.githubusercontent.com/vidarr-ventures/candy-map/main/CandyMap.kml";
";

        fetch(kmlUrl)
          .then((res) => res.text())
          .then((kmlText) => {
            const parser = new DOMParser();
            const xml = parser.parseFromString(kmlText, "text/xml");
            const placemarks = xml.getElementsByTagName("Placemark");

            for (let i = 0; i < placemarks.length; i++) {
              const name = placemarks[i].getElementsByTagName("name")[0]?.textContent || "";
              const coordsText = placemarks[i].getElementsByTagName("coordinates")[0]?.textContent || "";
              if (!coordsText) continue;

              const [lng, lat] = coordsText.trim().split(",").map(Number);

              // Extract candy count from name (e.g. "5 Lowell Street ‚Äî 1500 pieces")
              const candyMatch = name.match(/(\d{2,5})\s*pieces/i);
              const candyCount = candyMatch ? parseInt(candyMatch[1]) : 0;

              // Choose marker color
              let color = "green";
              if (candyCount >= 1000) color = "red";
              else if (candyCount >= 750) color = "orange";

              const marker = new google.maps.Marker({
                position: { lat, lng },
                map,
                title: name,
                icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  fillColor: color,
                  fillOpacity: 0.9,
                  strokeWeight: 1,
                  strokeColor: "#333",
                  scale: 7,
                },
              });

              const infoWindow = new google.maps.InfoWindow({
                content: `<strong>${name}</strong>`,
              });

              marker.addListener("click", () => {
                infoWindow.open(map, marker);
              });
            }
          })
          .catch((err) => {
            alert("‚ö†Ô∏è Could not load KML file. Make sure it is shared publicly.");
            console.error(err);
          });
      }

      function refreshMap() {
        document.getElementById("map").innerHTML = "";
        initMap();
      }

      window.onload = initMap;
    </script>
  </head>

  <body>
    <div id="header">
      üéÉ Carlisle Halloween Candy Map
      <button id="refresh-btn" onclick="refreshMap()">Refresh Map</button>
    </div>
    <div id="map"></div>
  </body>
</html>
