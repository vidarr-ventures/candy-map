<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Carlisle Halloween Candy Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
        width: 100%;
      }
      #header {
        background: #ff6600;
        color: white;
        text-align: center;
        font-family: Arial, sans-serif;
        font-weight: bold;
        padding: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 1000;
        position: fixed;
        width: 100%;
      }
    </style>

    <!-- Use your restricted API key here -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCo55WIobOFczEhfRbrzI5jCGXLA0A9yWk"></script>

    <script>
      let map;
      let kmlLayer;

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 42.529, lng: -71.35 }, // Carlisle, MA
          zoom: 14,
          mapTypeId: "roadmap",
        });

        loadKML(); // initial load
        setInterval(refreshKML, 5 * 60 * 1000); // refresh every 5 minutes
      }

      // Load the KML file with a cache-busting parameter
      function loadKML() {
        const kmlUrl =
          "https://raw.githubusercontent.com/vidarr-ventures/candy-map/main/CandyMap.kml?v=" +
          new Date().getTime();

        if (kmlLayer) {
          kmlLayer.setMap(null);
        }

        kmlLayer = new google.maps.KmlLayer({
          url: kmlUrl,
          map: map,
          preserveViewport: true,
          suppressInfoWindows: false,
        });

        kmlLayer.addListener("status_changed", () => {
          if (kmlLayer.getStatus() !== "OK") {
            console.warn("Could not load KML data. Ensure the file is public.");
          }
        });
      }

      // Explicit refresh wrapper (reloads KML only)
      function refreshKML() {
        console.log("Refreshing candy map KML...");
        loadKML();
      }

      window.onload = initMap;
    </script>
  </head>

  <body>
    <div id="header">ðŸŽƒ Carlisle Halloween Candy Map â€” auto-refreshes every 5 minutes</div>
    <div id="map"></div>
  </body>
</html>
